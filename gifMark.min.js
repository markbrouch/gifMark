(function(e){e.fn.gifMark=function(t){var n=function(e){return e.reduce(function(e,t){return e*2+t},0)};var r=function(e){var t=[];for(var n=7;n>=0;n--){t.push(!!(e&1<<n))}return t};var i=function(e){this.data=e;this.len=this.data.length;this.pos=0;this.readByte=function(){if(this.pos>=this.data.length){throw new Error("Attempted to read past end of stream.")}return e.charCodeAt(this.pos++)&255};this.readBytes=function(e){var t=[];for(var n=0;n<e;n++){t.push(this.readByte())}return t};this.read=function(e){var t="";for(var n=0;n<e;n++){t+=String.fromCharCode(this.readByte())}return t};this.readUnsigned=function(){var e=this.readBytes(2);return(e[1]<<8)+e[0]}};var s=function(e,t){var n=0;var r=function(e){var r=0;for(var i=0;i<e;i++){if(t.charCodeAt(n>>3)&1<<(n&7)){r|=1<<i}n++}return r};var i=[];var s=1<<e;var o=s+1;var u=e+1;var a=[];var f=function(){a=[];u=e+1;for(var t=0;t<s;t++){a[t]=[t]}a[s]=[];a[o]=null};var l;var c;while(true){c=l;l=r(u);if(l===s){f();continue}if(l===o)break;if(l<a.length){if(c!==s){a.push(a[c].concat(a[l][0]))}}else{if(l!==a.length)throw new Error("Invalid LZW code.");a.push(a[c].concat(a[c][0]))}i.push.apply(i,a[l]);if(a.length===1<<u&&u<12){u++}}return i};var o=function(e,t){t||(t={});var i=function(t){var n=[];for(var r=0;r<t;r++){n.push(e.readBytes(3))}return n};var o=function(){var t,n;n="";do{t=e.readByte();n+=e.read(t)}while(t!==0);return n};var u=function(){var s={};s.sig=e.read(3);s.ver=e.read(3);if(s.sig!=="GIF")throw new Error("Not a GIF file.");s.width=e.readUnsigned();s.height=e.readUnsigned();var o=r(e.readByte());s.gctFlag=o.shift();s.colorRes=n(o.splice(0,3));s.sorted=o.shift();s.gctSize=n(o.splice(0,3));s.bgColor=e.readByte();s.pixelAspectRatio=e.readByte();if(s.gctFlag){s.gct=i(1<<s.gctSize+1)}t.hdr&&t.hdr(s)};var a=function(i){var s=function(i){var s=e.readByte();var o=r(e.readByte());i.reserved=o.splice(0,3);i.disposalMethod=n(o.splice(0,3));i.userInput=o.shift();i.transparencyGiven=o.shift();i.delayTime=e.readUnsigned();i.transparencyIndex=e.readByte();i.terminator=e.readByte();t.gce&&t.gce(i)};var u=function(e){e.comment=o();t.com&&t.com(e)};var a=function(n){var r=e.readByte();n.ptHeader=e.readBytes(12);n.ptData=o();t.pte&&t.pte(n)};var f=function(n){var r=function(n){var r=e.readByte();n.unknown=e.readByte();n.iterations=e.readUnsigned();n.terminator=e.readByte();t.app&&t.app.NETSCAPE&&t.app.NETSCAPE(n)};var i=function(e){e.appData=o();t.app&&t.app[e.identifier]&&t.app[e.identifier](e)};var s=e.readByte();n.identifier=e.read(8);n.authCode=e.read(3);switch(n.identifier){case"NETSCAPE":r(n);break;default:i(n);break}};var l=function(e){e.data=o();t.unknown&&t.unknown(e)};i.label=e.readByte();switch(i.label){case 249:i.extType="gce";s(i);break;case 254:i.extType="com";u(i);break;case 1:i.extType="pte";a(i);break;case 255:i.extType="app";f(i);break;default:i.extType="unknown";l(i);break}};var f=function(u){var a=function(e,t){var n=new Array(e.length);var r=e.length/t;var i=function(r,i){var s=e.slice(i*t,(i+1)*t);n.splice.apply(n,[r*t,t].concat(s))};var s=[0,4,2,1];var o=[8,8,4,2];var u=0;for(var a=0;a<4;a++){for(var f=s[a];f<r;f+=o[a]){i(f,u);u++}}return n};u.leftPos=e.readUnsigned();u.topPos=e.readUnsigned();u.width=e.readUnsigned();u.height=e.readUnsigned();var f=r(e.readByte());u.lctFlag=f.shift();u.interlaced=f.shift();u.sorted=f.shift();u.reserved=f.splice(0,2);u.lctSize=n(f.splice(0,3));if(u.lctFlag){u.lct=i(1<<u.lctSize+1)}u.lzwMinCodeSize=e.readByte();var l=o();u.pixels=s(u.lzwMinCodeSize,l);if(u.interlaced){u.pixels=a(u.pixels,u.width)}t.img&&t.img(u)};var l=function(){var n={};n.sentinel=e.readByte();switch(String.fromCharCode(n.sentinel)){case"!":n.type="ext";a(n);break;case",":n.type="img";f(n);break;case";":n.type="eof";t.eof&&t.eof(n);break;default:throw new Error("Unknown block: 0x"+n.sentinel.toString(16))}if(n.type!=="eof")setTimeout(l,0)};var c=function(){u();setTimeout(l,0)};c()};var u=function(e){var t={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(var n in e){t[n]=e[n]}if(t.vp_w&&t.vp_h)t.is_vp=true;var r;var s;var u=null;var a=false;var f=null;var l=null;var c=null;var h=0;var p=null;var d=null;var v=null;var m=true;var g=true;var y=false;var b=[];var w=t.gif;if(typeof t.auto_play=="undefined")t.auto_play=!w.getAttribute("rel:auto_play")||w.getAttribute("rel:auto_play")=="1";var E=function(){f=null;l=null;p=c;c=null;d=null};var S=function(){try{o(r,H)}catch(e){C("parse")}};var x=function(e){q.innerHTML=e;q.style.visibility="visible"};var T=function(e,t){F.width=e*j();F.height=t*j();q.style.minWidth=e*j()+"px";R.width=e;R.height=t;R.style.width=e+"px";R.style.height=t+"px";R.getContext("2d").setTransform(1,0,0,1,0,0)};var N=function(e,n,r){if(r){var i=25;var s,o,u,a;if(t.is_vp){if(!y){u=t.vp_t+t.vp_h-i;i=i;s=t.vp_l;o=s+e/n*t.vp_w;a=F.width}else{u=(t.vp_t+t.vp_h-i)/j();i=i/j();s=t.vp_l/j();o=s+e/n*(t.vp_w/j());a=F.width/j()}if(false){if(!y){var f=t.vp_l,l=t.vp_t;var c=t.vp_w,h=t.vp_h}else{var f=t.vp_l/j(),l=t.vp_t/j();var c=t.vp_w/j(),h=t.vp_h/j()}I.rect(f,l,c,h);I.stroke()}}else{u=F.height-i;o=e/n*F.width;a=F.width}I.fillStyle="rgba(255,255,255,0.4)";I.fillRect(o,u,a-o,i);I.fillStyle="rgba(255,0,22,.8)";I.fillRect(0,u,o,i)}};var C=function(e){var n=function(){I.fillStyle="black";I.fillRect(0,0,t.c_w?t.c_w:s.width,t.c_h?t.c_h:s.height);I.strokeStyle="red";I.lineWidth=3;I.moveTo(0,0);I.lineTo(t.c_w?t.c_w:s.width,t.c_h?t.c_h:s.height);I.moveTo(0,t.c_h?t.c_h:s.height);I.lineTo(t.c_w?t.c_w:s.width,0);I.stroke()};u=e;s={width:w.width,height:w.height};b=[];n()};var k=function(e){s=e;T(s.width,s.height)};var L=function(e){A();E();f=e.transparencyGiven?e.transparencyIndex:null;l=e.delayTime;c=e.disposalMethod};var A=function(){if(!d)return;b.push({data:d.getImageData(0,0,s.width,s.height),delay:l})};var O=function(e){if(!d)d=R.getContext("2d");var t=b.length;var n=e.lctFlag?e.lct:s.gct;if(t>0){if(p===3){d.putImageData(b[h].data,0,0)}else{h=t-1}if(p===2){d.clearRect(v.leftPos,v.topPos,v.width,v.height)}}var r=d.getImageData(e.leftPos,e.topPos,e.width,e.height);var i=r.data;e.pixels.forEach(function(e,t){if(e!==f){i[t*4+0]=n[e][0];i[t*4+1]=n[e][1];i[t*4+2]=n[e][2];i[t*4+3]=255}});r.data=i;d.putImageData(r,e.leftPos,e.topPos);if(!y){I.scale(j(),j());y=true}I.drawImage(R,0,0);v=e};var M=function(){var e=-1;var n;var r;var i=false;var s=false;var o=function(t){e=(e+t+b.length)%b.length;n=e+1;r=b[e].delay;f()};var a=function(){var t=false;var n=function(){t=m;if(!t)return;o(g?1:-1);var r=b[e].delay*10;if(!r)r=100;setTimeout(n,r)};return function(){if(!t)setTimeout(n,0)}}();var f=function(){n=e;R.getContext("2d").putImageData(b[e].data,0,0);I.globalCompositeOperation="copy";I.drawImage(R,0,0)};var l=function(){m=true;a()};var c=function(){m=false};return{init:function(){if(u)return;if(!(t.c_w&&t.c_h)){I.scale(j(),j())}if(t.auto_play){a()}else{e=0;f()}},current_frame:n,step:a,play:l,pause:c,playing:m,move_relative:o,current_frame:function(){return e},length:function(){return b.length},move_to:function(t){e=t;f()}}}();var _=function(e){N(r.pos,r.data.length,e)};var D=function(){};var P=function(e,t){return function(n){e(n);_(t)}};var H={hdr:P(k),gce:P(L),com:P(D),app:{NETSCAPE:P(D)},img:P(O,true),eof:function(e){A();_(false);if(!(t.c_w&&t.c_h)){F.width=s.width*j();F.height=s.height*j()}M.init();a=false;if(z){z()}}};var B=function(){var e=w.parentNode;var n=document.createElement("div");F=document.createElement("canvas");I=F.getContext("2d");q=document.createElement("div");R=document.createElement("canvas");n.width=F.width=w.width;n.height=F.height=w.height;q.style.minWidth=w.width+"px";n.className="jsgif";q.className="jsgif_toolbar";n.appendChild(F);n.appendChild(q);e.insertBefore(n,w);e.removeChild(w);if(t.c_w&&t.c_h)T(t.c_w,t.c_h)};var j=function(){var e;if(t.max_width&&s){e=t.max_width/s.width}else{e=1}return e};var F,I,q,R;var U=false;var z=false;return{play:M.play,pause:M.pause,move_relative:M.move_relative,move_to:M.move_to,get_playing:function(){return M.playing},get_canvas:function(){return F},get_canvas_scale:function(){return j()},get_loading:function(){return a},get_auto_play:function(){return t.auto_play},get_length:function(){return M.length()},get_current_frame:function(){return M.current_frame()},load:function(e){if(e)z=e;a=true;var t=new XMLHttpRequest;t.overrideMimeType("text/plain; charset=x-user-defined");t.onloadstart=function(){if(!U)B()};t.onload=function(e){r=new i(t.responseText);setTimeout(S,0)};t.onprogress=function(e){if(e.lengthComputable)N(e.loaded,e.total,true)};t.onerror=function(){C("xhr")};t.open("GET",w.getAttribute("rel:animated_src")||w.src,true);t.send()}}};var a=new u({gif:this.get()[0]});a.load();e(a.get_canvas()).on({play:a.play,pause:a.pause,moveTo:function(e,t){a.move_to(t)},moveRelative:function(e,t){a.move_relative(t)}});return a.get_canvas()}})(jQuery)